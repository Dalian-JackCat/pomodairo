<?xml version="1.0" encoding="utf-8"?>
<s:BorderContainer
	xmlns:fx="http://ns.adobe.com/mxml/2009"
	xmlns:s="library://ns.adobe.com/flex/spark"
	xmlns:mx="library://ns.adobe.com/flex/mx"
	x="10" y="5" width="298" height="154" backgroundColor="#313131"
	creationComplete="init()">

	<fx:Script>
        <![CDATA[
        	import com.pomodairo.PomodoroEventDispatcher;
        	import com.pomodairo.db.Storage;
        	import com.pomodairo.events.ConfigurationUpdatedEvent;
			import flash.events.Event;
			import flash.filesystem.File;
			import flash.net.FileFilter;

        	public static var FADE_TICKING_SOUND:String = "sound.fadeTicking";
			public static var ALARM_SOUND_FILE:String = "sound.alarmSound";
			public static var CLOCK_SOUND_FILE:String = "sound.clockSound";
        	
        	private var soundEnabled:Boolean = new Boolean(true);
        	private var volume:Number = new Number(100);
        	
        	private var fadeTicking:Boolean = new Boolean(true);
			
			private var alarmSound:String = "";
			private var clockSound:String = "";
        	
			private var soundTypes:FileFilter = new FileFilter("Audio Files (*.mp3)", "*.mp3");
			private var fileTypes:Array = new Array(soundTypes);
			private var alarmSoundFile:File = new File();
			private var clockSoundFile:File = new File();
			
        	private function init():void
        	{
        		populate();
        		applyGuiValues();	
        	}
        	
        	public function populate():void
        	{
        		var props:Dictionary = Storage.instance.config;
        		if (props["volume"] != null) 
        		{
        			volume = props["volume"];
        		}
        		
        		if (props["sound"] != null) 
        		{
        			soundEnabled = props["sound"] == "true";
        		}
        		
        		if (props[FADE_TICKING_SOUND] != null) 
        		{
        			fadeTicking = props[FADE_TICKING_SOUND] == "true";
        		}
				
				if (props[ALARM_SOUND_FILE] != null) 
				{
					alarmSound = props[ALARM_SOUND_FILE];
				}
				
				if (props[CLOCK_SOUND_FILE] != null) 
				{
					clockSound = props[CLOCK_SOUND_FILE];
				}
        		
        	}
        	
        	private function applyGuiValues():void
            {
        		volumeSlider.value = volume;
        		soundCheckbox.selected = soundEnabled;
        		fadeTickingCheckbox.selected = fadeTicking;
				alarmFileLocationInput.text = alarmSound;
				clockFileLocationInput.text = clockSound;
            }
        	
            private function exit():void
            {
            	this.parent.removeChild(this);
            }
            
            public function save():void
            {
            	volume = volumeSlider.value;
            	soundEnabled = soundCheckbox.selected;
            	fadeTicking = fadeTickingCheckbox.selected;
				alarmSound = alarmFileLocationInput.text;
				clockSound = clockFileLocationInput.text;
            	
            	Storage.instance.setConfigurationValue("volume", ""+volume);
            	Storage.instance.setConfigurationValue("sound", ""+soundEnabled);
            	Storage.instance.setConfigurationValue(FADE_TICKING_SOUND, ""+fadeTicking);
				Storage.instance.setConfigurationValue(ALARM_SOUND_FILE, ""+alarmSound);
				Storage.instance.setConfigurationValue(CLOCK_SOUND_FILE, ""+clockSound);
            	exit();
            	
            	notifyConfiguration();
            }
            
            public function notifyConfiguration():void
            {
            	// Notify the world 
            	PomodoroEventDispatcher.getInstance().dispatchEvent(new ConfigurationUpdatedEvent(ConfigurationUpdatedEvent.UPDATED, "volume", ""+volume));
            	PomodoroEventDispatcher.getInstance().dispatchEvent(new ConfigurationUpdatedEvent(ConfigurationUpdatedEvent.UPDATED, "sound", ""+soundEnabled));
            	PomodoroEventDispatcher.getInstance().dispatchEvent(new ConfigurationUpdatedEvent(ConfigurationUpdatedEvent.UPDATED, FADE_TICKING_SOUND, ""+fadeTicking));
				PomodoroEventDispatcher.getInstance().dispatchEvent(new ConfigurationUpdatedEvent(ConfigurationUpdatedEvent.UPDATED, ALARM_SOUND_FILE, ""+alarmSound));
				PomodoroEventDispatcher.getInstance().dispatchEvent(new ConfigurationUpdatedEvent(ConfigurationUpdatedEvent.UPDATED, CLOCK_SOUND_FILE, ""+clockSound));
            }
			
			private function selectAlarmFile():void {
				alarmSoundFile.addEventListener(Event.SELECT, setAlarmFilePath);
				alarmSoundFile.browse(fileTypes);
			}
			
			private function setAlarmFilePath(event:Event):void {
				alarmFileLocationInput.text = alarmSoundFile.nativePath;
				alarmSound = alarmSoundFile.nativePath;
			}      
			
			private function selectClockFile():void {
				clockSoundFile.addEventListener(Event.SELECT, setClockFilePath);
				clockSoundFile.browse(fileTypes);
			}
			
			private function setClockFilePath(event:Event):void {
				clockFileLocationInput.text = clockSoundFile.nativePath;
				clockSound = clockSoundFile.nativePath;
			}      
			            
        ]]>
    </fx:Script>

	<s:CheckBox id="soundCheckbox" x="178.8" y="15.3" label="Sound enabled"/>
	<s:CheckBox id="fadeTickingCheckbox" x="178.8" y="45.3" label="Fade ticking"/>
	<s:Button x="221" y="90" label="Save" click="save()" width="63"/>
	<s:Button x="221" y="121" label="Cancel" click="exit()"/>
	<s:HSlider id="volumeSlider" x="10" y="12" minimum="0" maximum="100" snapInterval="5"/>
	<s:Label x="10" y="4" text="Volume" color="#A9A9A9"/>
	
	<s:Label x="10" y="58.7" color="#A9A9A9" text="Alarm Sound:"/>
	<s:TextInput id="alarmFileLocationInput" x="10" y="76" width="131">
		<s:toolTip>Custom sound file for the alarm. Leave empty for default.</s:toolTip>
	</s:TextInput>
	<s:Button x="149" y="76" label="Browse" click="selectAlarmFile()" width="64"/>
	
	<s:Label x="10" y="106" color="#A9A9A9" text="Clock Sound:"/>
	<s:TextInput id="clockFileLocationInput" x="10" y="122" width="131">
		<s:toolTip>Custom sound file for the clock sound. Leave empty for default.</s:toolTip>
	</s:TextInput>
	<s:Button x="149" y="122" label="Browse" click="selectClockFile()" width="64"/>
	
</s:BorderContainer>
